package com.chargebee.v4.models.{{module}}.responses;

import java.math.BigDecimal;
import java.util.List;
import java.util.ArrayList;
import java.sql.Timestamp;

{{#each imports}}
import {{packageName}}.{{name}};
{{/each}}
import com.chargebee.v4.exceptions.ChargebeeException;
import com.chargebee.v4.internal.JsonUtil;
import com.chargebee.v4.internal.ParseContext;
import com.chargebee.v4.transport.Response;
import com.chargebee.v4.services.{{serviceName}};
import com.chargebee.v4.models.{{module}}.params.{{name}}Params;

/**
 * Immutable response object for {{name}} operation.
 * Contains paginated list data.
 */
public final class {{name}}Response {
    {{#each fields}}
    private final {{{type}}} {{name}};
    {{/each}}
    {{#if hasPathParams}}
    private final String {{pathParamName}};
    {{/if}}
    private final {{serviceName}} service;
    private final {{name}}Params originalParams;
    private final Response httpResponse;

    private {{name}}Response(
        {{#each fields}}{{{type}}} {{name}}{{#unless @last}}, {{/unless}}{{/each}}{{#if hasPathParams}}, String {{pathParamName}}{{/if}},
        {{serviceName}} service,
        {{name}}Params originalParams,
        Response httpResponse
    ) {
        {{#each fields}}
        this.{{name}} = {{name}};
        {{/each}}
        {{#if hasPathParams}}
        this.{{pathParamName}} = {{pathParamName}};
        {{/if}}
        this.service = service;
        this.originalParams = originalParams;
        this.httpResponse = httpResponse;
    }

    

    /**
     * Parse JSON response into {{name}}Response object (no service context).
     * Use this when you only need to read a single page (no nextPage()).
     */
    public static {{name}}Response fromJson(String json) {
        try {
            ParseContext ctx = new ParseContext(json);
            {{#each fields}}
            {{#if isComplexObjectType}}
            {{{type}}} {{name}} = {{{type}}}.fromJson(JsonUtil.getObject(ctx, "{{curlName}}"));
            {{else if isEnumType}}
            {{{type}}} {{name}} = {{{type}}}.fromString(JsonUtil.getString(ctx, "{{curlName}}"));
            {{else if isListOfObjects}}
              {{#if listElementType}}
                {{#unless (eq listElementType "Object")}}
                {{{type}}} {{name}} =
                    JsonUtil.parseObjectArray(JsonUtil.getArray(ctx, "{{curlName}}"))
                        .stream()
                        .map({{listElementType}}::fromJson)
                        .collect(java.util.stream.Collectors.toList());
                {{else}}
                {{{type}}} {{name}} =
                    new ArrayList<>(JsonUtil.parseObjectArray(JsonUtil.getArray(ctx, "{{curlName}}")));
                {{/unless}}
              {{else}}
              {{{type}}} {{name}} =
                  JsonUtil.parseArrayOfString(JsonUtil.getArray(ctx, "{{curlName}}"));
              {{/if}}
            {{else if isListOfPrimitives}}
            {{{type}}} {{name}} =
                JsonUtil.parseArrayOfString(JsonUtil.getArray(ctx, "{{curlName}}"));
            {{else if isListType}}
            {{#if (eq listElementType "Object")}}
            {{{type}}} {{name}} =
                JsonUtil.parseObjectArray(JsonUtil.getArray(ctx, "{{curlName}}"))
                    .stream()
                    .map(JsonUtil::parseJsonObjectToMap)
                    .collect(java.util.stream.Collectors.toList());
            {{else if (eq listElementType "java.util.Map<String, Object>")}}
            {{{type}}} {{name}} =
                JsonUtil.parseObjectArray(JsonUtil.getArray(ctx, "{{curlName}}"))
                    .stream()
                    .map(JsonUtil::parseJsonObjectToMap)
                    .collect(java.util.stream.Collectors.toList());
            {{else}}
            {{{type}}} {{name}} =
                JsonUtil.parseArrayOfString(JsonUtil.getArray(ctx, "{{curlName}}"));
            {{/if}}
            {{else if isObjectType}}
            {{#unless (eq type "Object")}}
            {{{type}}} {{name}} = {{{type}}}.fromJson(JsonUtil.getObject(ctx, "{{curlName}}"));
            {{else}}
            {{{type}}} {{name}} = JsonUtil.getObject(ctx, "{{curlName}}");
            {{/unless}}
            {{else}}
            {{{type}}} {{name}} = JsonUtil.get{{{type}}}(ctx, "{{curlName}}");
            {{/if}}
            {{/each}}

            return new {{name}}Response({{#each fields}}{{name}}{{#unless @last}}, {{/unless}}{{/each}}{{#if hasPathParams}}, null{{/if}}, null, null, null);
        } catch (Exception e) {
            throw new RuntimeException("Failed to parse {{name}}Response from JSON", e);
        }
    }

    /**
     * Parse JSON response into {{name}}Response object with service context
     * for pagination (enables nextPage()).
     */
    public static {{name}}Response fromJson(String json, {{serviceName}} service, {{name}}Params originalParams{{#if hasPathParams}}, String {{pathParamName}}{{/if}}, Response httpResponse) {
        try {
            ParseContext ctx = new ParseContext(json);
            {{#each fields}}
            {{#if isComplexObjectType}}
            {{{type}}} {{name}} = {{{type}}}.fromJson(JsonUtil.getObject(ctx, "{{curlName}}"));
            {{else if isEnumType}}
            {{{type}}} {{name}} = {{{type}}}.fromString(JsonUtil.getString(ctx, "{{curlName}}"));
            {{else if isListOfObjects}}
              {{#if listElementType}}
                {{#unless (eq listElementType "Object")}}
                {{{type}}} {{name}} =
                    JsonUtil.parseObjectArray(JsonUtil.getArray(ctx, "{{curlName}}"))
                        .stream()
                        .map({{listElementType}}::fromJson)
                        .collect(java.util.stream.Collectors.toList());
                {{else}}
                {{{type}}} {{name}} =
                    new ArrayList<>(JsonUtil.parseObjectArray(JsonUtil.getArray(ctx, "{{curlName}}")));
                {{/unless}}
              {{else}}
              {{{type}}} {{name}} =
                  JsonUtil.parseArrayOfString(JsonUtil.getArray(ctx, "{{curlName}}"));
              {{/if}}
            {{else if isListOfPrimitives}}
            {{{type}}} {{name}} =
                JsonUtil.parseArrayOfString(JsonUtil.getArray(ctx, "{{curlName}}"));
            {{else if isListType}}
            {{#if (eq listElementType "Object")}}
            {{{type}}} {{name}} =
                JsonUtil.parseObjectArray(JsonUtil.getArray(ctx, "{{curlName}}"))
                    .stream()
                    .map(JsonUtil::parseJsonObjectToMap)
                    .collect(java.util.stream.Collectors.toList());
            {{else if (eq listElementType "java.util.Map<String, Object>")}}
            {{{type}}} {{name}} =
                JsonUtil.parseObjectArray(JsonUtil.getArray(ctx, "{{curlName}}"))
                    .stream()
                    .map(JsonUtil::parseJsonObjectToMap)
                    .collect(java.util.stream.Collectors.toList());
            {{else}}
            {{{type}}} {{name}} =
                JsonUtil.parseArrayOfString(JsonUtil.getArray(ctx, "{{curlName}}"));
            {{/if}}
            {{else if isObjectType}}
            {{#unless (eq type "Object")}}
            {{{type}}} {{name}} = {{{type}}}.fromJson(JsonUtil.getObject(ctx, "{{curlName}}"));
            {{else}}
            {{{type}}} {{name}} = JsonUtil.getObject(ctx, "{{curlName}}");
            {{/unless}}
            {{else}}
            {{{type}}} {{name}} = JsonUtil.get{{{type}}}(ctx, "{{curlName}}");
            {{/if}}
            {{/each}}

            return new {{name}}Response({{#each fields}}{{name}}{{#unless @last}}, {{/unless}}{{/each}}{{#if hasPathParams}}, {{pathParamName}}{{/if}}, service, originalParams, httpResponse);
        } catch (Exception e) {
            throw new RuntimeException("Failed to parse {{name}}Response from JSON", e);
        }
    }

    {{#each fields}}
    /** Get the {{name}} from the response. */
    public {{{type}}} {{getterName}}() {
        return {{name}};
    }
    {{/each}}

    /** Check if there are more pages available. */
    public boolean hasNextPage() {
        return {{nextOffsetField}} != null && !{{nextOffsetField}}.isEmpty();
    }

    /**
     * Get the next page of results.
     * @throws ChargebeeException if unable to fetch next page
     */
    public {{name}}Response nextPage() throws ChargebeeException {
        if (!hasNextPage()) {
            throw new IllegalStateException("No more pages available");
        }
        if (service == null) {
            throw new UnsupportedOperationException("nextPage() requires service context. Use fromJson(json, service, originalParams, httpResponse).");
        }

        {{name}}Params nextParams = (originalParams != null ? originalParams.toBuilder() : {{name}}Params.builder())
            .offset({{nextOffsetField}})
            .build();

        return service.{{operationMethodName}}({{#if hasPathParams}}{{pathParamName}}, {{/if}}nextParams);
    }

    /**
     * Get the raw response payload as JSON string.
     */
    public String responsePayload() {
        return httpResponse != null ? httpResponse.getBodyAsString() : null;
    }

    /**
     * Get the HTTP status code.
     */
    public int httpStatus() {
        return httpResponse != null ? httpResponse.getStatusCode() : 0;
    }

    /**
     * Get response headers.
     */
    public java.util.Map<String, java.util.List<String>> headers() {
        return httpResponse != null ? httpResponse.getHeaders() : java.util.Collections.emptyMap();
    }

    /**
     * Get a specific header value.
     */
    public java.util.List<String> header(String name) {
        if (httpResponse == null) return null;
        return httpResponse.getHeaders().entrySet().stream()
            .filter(e -> e.getKey().equalsIgnoreCase(name))
            .map(java.util.Map.Entry::getValue)
            .findFirst()
            .orElse(null);
    }

    @Override
    public String toString() {
        return "{{name}}Response{" +
        {{#each fields}}
            "{{#unless @first}}, {{/unless}}{{name}}=" + {{name}} +
        {{/each}}
            "}";
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        {{#if fields}}
        {{name}}Response that = ({{name}}Response) o;
        return {{#each fields}}java.util.Objects.equals({{name}}, that.{{name}}){{#unless @last}} &&
            {{/unless}}{{/each}};
        {{else}}
        return true;
        {{/if}}
    }

    @Override
    public int hashCode() {
        {{#if fields}}
        return java.util.Objects.hash({{#each fields}}{{name}}{{#unless @last}}, {{/unless}}{{/each}});
        {{else}}
        return 0;
        {{/if}}
    }

    {{#each subModels}}
    public static class {{name}} {
        {{#each fields}}
        private {{{type}}} {{name}};
        {{/each}}
    
        {{#each fields}}
        public {{{type}}} {{getterName}}() {
            return {{name}};
        }
        {{/each}}


    public static {{name}} fromJson(String json) {
        ParseContext ctx = new ParseContext(json);
        {{name}} item = new {{name}}();
        {{#each fields}}
        {{#if isMapType}}
        String __{{name}}Json = JsonUtil.getObject(ctx, "{{curlName}}");
        item.{{name}} = __{{name}}Json != null ? JsonUtil.parseJsonObjectToMap(__{{name}}Json) : new java.util.HashMap<>();
        {{else if isComplexObjectType}}
        String __{{name}}Json = JsonUtil.getObject(ctx, "{{curlName}}");
        if (__{{name}}Json != null) {
        item.{{name}} = {{{type}}}.fromJson(__{{name}}Json);
        }
        {{else if isObjectType}}
        {{#unless (eq type "Object")}}
        item.{{name}} = {{{type}}}.fromJson(JsonUtil.getObject(ctx, "{{curlName}}"));
        {{else}}
        item.{{name}} = JsonUtil.getObject(ctx, "{{curlName}}");
        {{/unless}}
        {{else if isEnumType}}
        item.{{name}} = {{{type}}}.fromString(JsonUtil.getString(ctx, "{{curlName}}"));
        {{else if isListOfObjects}}
        item.{{name}} = JsonUtil.parseObjectArray(JsonUtil.getArray(ctx, "{{curlName}}")).stream().map({{listElementType}}::fromJson).collect(java.util.stream.Collectors.toList());
        {{else if isListType}}
        {{#if (eq listElementType "Object")}}
        item.{{name}} = new ArrayList<>(JsonUtil.parseObjectArray(JsonUtil.getArray(ctx, "{{curlName}}")));
        {{else}}
        item.{{name}} = JsonUtil.parseArrayOfString(JsonUtil.getArray(ctx, "{{curlName}}"));
        {{/if}}
        {{else}}
        item.{{name}} = JsonUtil.get{{type}}(ctx, "{{curlName}}");
        {{/if}}
        {{/each}}
        return item;
    }

        @Override
        public String toString() {
            return "{{name}}{" +
            {{#each fields}}
                "{{#unless @first}}, {{/unless}}{{name}}=" + {{name}} +
            {{/each}}
                "}";
        }

        @Override
        public boolean equals(Object o) {
            if (this == o) return true;
            if (o == null || getClass() != o.getClass()) return false;
            {{#if fields}}
            {{name}} that = ({{name}}) o;
            return {{#each fields}}java.util.Objects.equals({{name}}, that.{{name}}){{#unless @last}} &&
                {{/unless}}{{/each}};
            {{else}}
            return true;
            {{/if}}
        }

        @Override
        public int hashCode() {
            {{#if fields}}
            return java.util.Objects.hash({{#each fields}}{{name}}{{#unless @last}}, {{/unless}}{{/each}});
            {{else}}
            return 0;
            {{/if}}
        }
    }
    {{/each}}
}

