/*
 * This file is auto-generated by Chargebee.
 * For more information on how to make changes to this file, please see the README.
 * Reach out to dx@chargebee.com for any questions.
 * Copyright 2025 Chargebee Inc.
 */

package com.chargebee.v4.internal;

import com.chargebee.v4.internal.ParseContext;
import com.chargebee.v4.transport.Response;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

/**
 * Result of a batch API operation.
 * Contains individual responses for each entry in the batch request.
 */
public class BatchResult {

    private final int httpStatusCode;
    private final String rawJson;
    private final Response response;
    private final List<BatchResponse> results;

    private BatchResult(int httpStatusCode, String rawJson, Response response, List<BatchResponse> results) {
        this.httpStatusCode = httpStatusCode;
        this.rawJson = rawJson;
        this.response = response;
        this.results = Collections.unmodifiableList(results);
    }

    /**
     * Parse a batch result from a JSON response.
     */
    public static BatchResult fromJson(String json, Response response) {
        List<BatchResponse> results = new ArrayList<>();
        ParseContext ctx = new ParseContext(json);
        String resultsArray = JsonUtil.getArray(ctx, BatchConstants.RESULTS_KEY);
        if (resultsArray != null) {
            List<String> items = JsonUtil.parseObjectArray(resultsArray);
            for (String item : items) {
                ParseContext itemCtx = new ParseContext(item);
                String correlationId = JsonUtil.getString(itemCtx, BatchConstants.CORRELATION_ID);
                String content = JsonUtil.getObject(itemCtx, BatchConstants.RESULT_CONTENT_KEY);
                results.add(new BatchResponse(correlationId, content));
            }
        }
        return new BatchResult(response.getStatusCode(), json, response, results);
    }

    public int getHttpStatusCode() {
        return httpStatusCode;
    }

    public String getRawJson() {
        return rawJson;
    }

    public Response getResponse() {
        return response;
    }

    public List<BatchResponse> getResults() {
        return results;
    }

    /**
     * Represents a single response within a batch result.
     */
    public static class BatchResponse {
        private final String correlationId;
        private final String content;

        public BatchResponse(String correlationId, String content) {
            this.correlationId = correlationId;
            this.content = content;
        }

        public String getCorrelationId() {
            return correlationId;
        }

        /**
         * Get the raw JSON content of this batch response entry.
         */
        public String getContent() {
            return content;
        }
    }
}