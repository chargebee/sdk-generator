/*
 * This file is auto-generated by Chargebee.
 * For more information on how to make changes to this file, please see the README.
 * Reach out to dx@chargebee.com for any questions.
 * Copyright 2025 Chargebee Inc.
 */

package com.chargebee.v4.internal;

import com.chargebee.v4.client.ChargebeeClient;
import com.chargebee.v4.exceptions.ChargebeeException;
import com.chargebee.v4.transport.Request;
import com.chargebee.v4.transport.Response;
import com.chargebee.v4.transport.UrlBuilder;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;

/**
 * Builder for batch API operations.
 * Allows adding multiple entries and executing them as a single batch request.
 *
 * <pre>{@code
 * BatchResult result = client.ramp().batchUpdate()
 *     .addEntry(Map.of("id", "ramp_123", "status", "active"))
 *     .addEntry(Map.of("id", "ramp_456", "status", "paused"), "corr-1")
 *     .request();
 * }</pre>
 */
public class BatchRequest {

    private final String uri;
    private final String pathParamName;
    private final SubDomain subDomain;
    private final ChargebeeClient client;
    private final List<BatchEntry> entries = new ArrayList<>();

    public BatchRequest(String uri, String pathParamName, ChargebeeClient client) {
        this(uri, pathParamName, null, client);
    }

    public BatchRequest(String uri, String pathParamName, SubDomain subDomain, ChargebeeClient client) {
        this.uri = uri;
        this.pathParamName = pathParamName;
        this.subDomain = subDomain;
        this.client = client;
    }

    /**
     * Add an entry to this batch request.
     *
     * @param parameters the parameters for this entry
     * @return this BatchRequest for chaining
     */
    public BatchRequest addEntry(Map<String, Object> parameters) {
        entries.add(new BatchEntry(parameters, null));
        return this;
    }

    /**
     * Add an entry with a correlation ID for tracking in the response.
     *
     * @param parameters the parameters for this entry
     * @param correlationId an identifier to correlate this entry with its result
     * @return this BatchRequest for chaining
     */
    public BatchRequest addEntry(Map<String, Object> parameters, String correlationId) {
        entries.add(new BatchEntry(parameters, correlationId));
        return this;
    }

    /**
     * Execute this batch request synchronously.
     *
     * @return the batch result containing individual responses
     * @throws ChargebeeException if the API call fails
     */
    public BatchResult request() throws ChargebeeException {
        String jsonPayload = buildRequestPayload();
        String baseUrl = (subDomain != null)
                ? client.getBaseUrlWithSubDomain(subDomain.getValue())
                : client.getBaseUrl();
        String fullUrl = UrlBuilder.buildUrl(baseUrl, "/batch" + uri, null);
        Request.Builder reqBuilder = Request.builder()
                .method("POST")
                .url(fullUrl)
                .jsonBody(jsonPayload);
        for (Map.Entry<String, String> h : client.getClientHeaders().getHeaders().entrySet()) {
            reqBuilder.header(h.getKey(), h.getValue());
        }
        Request httpRequest = reqBuilder.build();
        Response response = client.executeWithInterceptor(httpRequest);
        return BatchResult.fromJson(response.getBodyAsString(), response);
    }

    /**
     * Build the JSON payload for the batch request.
     */
    String buildRequestPayload() {
        StringBuilder sb = new StringBuilder();
        sb.append("{\"").append(BatchConstants.REQUESTS_KEY).append("\":[");
        for (int i = 0; i < entries.size(); i++) {
            if (i > 0) {
                sb.append(',');
            }
            sb.append(entries.get(i).toJson());
        }
        sb.append("]}");
        return sb.toString();
    }
}