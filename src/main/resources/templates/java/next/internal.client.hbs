/*
 * This file is auto-generated by Chargebee.
 * For more information on how to make changes to this file, please see the README.
 * Reach out to dx@chargebee.com for any questions.
 * Copyright 2025 Chargebee Inc.
 */

package com.chargebee.v4.internal;

import com.chargebee.v4.client.ChargebeeClient;
import com.chargebee.v4.client.request.RequestInterceptor;
import com.chargebee.v4.exceptions.ConfigurationException;
import com.chargebee.v4.internal.RetryConfig;
import com.chargebee.v4.transport.RequestLogger;
import com.chargebee.v4.transport.Transport;

import java.io.InputStream;
import java.util.Map;
import java.util.Properties;

/**
 * Factory for creating Chargebee internal SDK client instances.
 * Requires a mandatory {@code serviceName} parameter that is included in the User-Agent header
 * for Splunk observability.
 *
 * <p>The User-Agent format is: {@code Chargebee-Java-Internal-Client v{version}-{serviceName}}
 *
 * <pre>{@code
 * ChargebeeClient client = InternalChargebeeClient.builder("api_key", "site", "billing-service")
 *     .build();
 * // Sends: User-Agent: Chargebee-Java-Internal-Client v4.0.1-billing-service
 * }</pre>
 */
public final class InternalChargebeeClient {

    private static final String USER_AGENT_PREFIX = "Chargebee-Java-Internal-Client";

    private InternalChargebeeClient() {
        // Utility class, not instantiable
    }

    /**
     * Create a new builder with mandatory serviceName.
     *
     * @param apiKey      the Chargebee API key (required)
     * @param siteName    the Chargebee site name (required)
     * @param serviceName the internal microservice name, used in User-Agent for Splunk (required)
     * @return a new Builder instance
     */
    public static Builder builder(String apiKey, String siteName, String serviceName) {
        return new Builder(apiKey, siteName, serviceName);
    }

    /**
     * Builder that wraps {@link ChargebeeClient.Builder} with mandatory serviceName.
     * Builds and returns a standard {@link ChargebeeClient} with the internal User-Agent set.
     */
    public static final class Builder {
        private final String serviceName;
        private final ChargebeeClient.Builder delegate;

        private Builder(String apiKey, String siteName, String serviceName) {
            if (serviceName == null || serviceName.trim().isEmpty()) {
                throw new ConfigurationException(
                    "serviceName is required for internal SDK client. "
                    + "It identifies the calling microservice in the User-Agent header.");
            }
            this.serviceName = serviceName;
            this.delegate = ChargebeeClient.builder(apiKey, siteName);
        }

        public Builder endpoint(String endpoint) {
            delegate.endpoint(endpoint);
            return this;
        }

        public Builder transport(Transport transport) {
            delegate.transport(transport);
            return this;
        }

        public Builder retry(RetryConfig retry) {
            delegate.retry(retry);
            return this;
        }

        public Builder retryConfig(RetryConfig retryConfig) {
            delegate.retryConfig(retryConfig);
            return this;
        }

        public Builder connectTimeout(int connectTimeout) {
            delegate.connectTimeout(connectTimeout);
            return this;
        }

        public Builder readTimeout(int readTimeout) {
            delegate.readTimeout(readTimeout);
            return this;
        }

        public Builder timeout(int connectTimeoutMs, int readTimeoutMs) {
            delegate.timeout(connectTimeoutMs, readTimeoutMs);
            return this;
        }

        public Builder debugLogging(boolean debugLogging) {
            delegate.debugLogging(debugLogging);
            return this;
        }

        public Builder requestLogger(RequestLogger requestLogger) {
            delegate.requestLogger(requestLogger);
            return this;
        }

        public Builder domainSuffix(String domainSuffix) {
            delegate.domainSuffix(domainSuffix);
            return this;
        }

        public Builder protocol(String protocol) {
            delegate.protocol(protocol);
            return this;
        }

        public Builder requestInterceptor(RequestInterceptor requestInterceptor) {
            delegate.requestInterceptor(requestInterceptor);
            return this;
        }

        public Builder header(String name, String value) {
            delegate.header(name, value);
            return this;
        }

        public Builder headers(Map<String, String> headers) {
            delegate.headers(headers);
            return this;
        }

        /**
         * Build the ChargebeeClient with the internal User-Agent header.
         * The User-Agent will be: {@code Chargebee-Java-Internal-Client v{version}-{serviceName}}
         *
         * @return configured ChargebeeClient with internal User-Agent
         */
        public ChargebeeClient build() {
            String version = getVersion();
            String userAgent = USER_AGENT_PREFIX + " v" + version + "-" + serviceName;
            delegate.header("User-Agent", userAgent);
            return delegate.build();
        }

        private static String getVersion() {
            try (InputStream is = InternalChargebeeClient.class.getClassLoader()
                    .getResourceAsStream("version.properties")) {
                if (is != null) {
                    Properties props = new Properties();
                    props.load(is);
                    return props.getProperty("version", "unknown");
                }
            } catch (Exception e) {
                // Ignore and use default
            }
            return "unknown";
        }
    }
}
